# 16S-ITS-23S_Analysis_Pipeline

This repository contains a two-part pipeline for processing and analyzing 16S-ITS-23S rRNA sequencing data on the Apollo server (apollo-acc.coh.org) at City of Hope (Duarte, CA) in both batch and interactive job modes. For detailed information on the server, visit HPRCC (http://hprcc.coh.org/). 

The pipeline comprises two Python scripts:

### 1. 16S_rRNA_Sequencing_Analysis.py
    This script performs initial processing of raw sequencing data by:
        * Optionally performing Skera Split (can be skipped)
        * Demultiplexing with Lima
        * Validating and filtering BAM files based on filename patterns and file size
        * Converting BAM files to FASTA and/or FASTQ
        * Generating FASTA indexes with samtools
        * Combining individual FASTA files into a single combined.fasta file along with a group file mapping sequence IDs to sample names

### 2. mothur_processing.py
    This script uses mothur to perform further downstream analysis on the combined FASTA file:
        * Summarizing sequence statistics with summary.seqs
        * Classifying sequences using classify.seqs
        * Optionally removing unclassified lineages using remove.lineage

## Dependencies
### Modules (Example Environment Setup)
Below is an example of how to set up the environment using module commands:

#Purge any loaded modules to start fresh \
module purge

#Load the necessary modules for Analysis \
module load smrtlink/13.1 \
module load samtools/1.17 \
module load seqtk/1.3 

#Load the necessary module for Mothur Processing (when running mothur_processing.py) \
module load mothur/1.48

#Verify loaded modules \
module list

## Usage

### 1. Running the 16S_rRNA_Sequencing_Analysis.py Script
This script processes the input BAM file and converts it into combined FASTA and group files. It accepts the following key arguments: \

--input-bam: Path to the input BAM file. \
--skip-skera: Flag to skip the Skera Split step. \
--adapters-fasta: Path to the adapters FASTA file. \
--barcodes-fasta: Path to the barcodes FASTA file. \
--output-dir: Directory where all output files will be saved. \
--athena-db: Path to the Athena database directory. \
--barcode-type: Type of barcode (symmetric or asymmetric). \
--sample-barcode-csv: Path to the sample barcode CSV file (must contain "Barcode" and "Sample Name" columns). \
--convert-types: Format(s) for conversion (fasta and/or fastq). \
--compression-level: Compression level for output files (1-9). \
--uncompressed: Flag to output uncompressed FASTA/FASTQ files.

### Example Command
python3 16S_rRNA_Sequencing_Analysis.py \
    --input-bam "../*.hifi_reads.bam" \
    --skip-skera \
    --adapters-fasta "../Kinnex_16S_Adapter_v2_MAS12.fasta" \
    --barcodes-fasta "../Kinnex_16S_384-plex_primers.fasta" \
    --output-dir "../output_dir" \
    --athena-db "../sbanalyzer/lib/athena_v2_2" \
    --barcode-type asymmetric \
    --sample-barcode-csv "../sample-barcode.csv" \
    --convert-types fasta fastq \
    --compression-level 1 \
    --uncompressed

### 2. Running the mothur_processing.py Script
This script performs downstream analysis on the combined FASTA file generated by the previous script. It accepts the following key arguments:

    --combined-fasta: Path to the combined FASTA file.
    --combined-group: Path to the combined group file.
    --output-dir: Directory for output files.
    --reference-fasta: Path to the reference FASTA file for classification.
    --taxonomy-file: Path to the taxonomy file.
    --method: Classification method (default: knn).
    --numwanted: Number of taxonomic classifications to retain per sequence (default: 1).
    --search: Search algorithm for classification (default: blastplus).
    --processors: Number of processors to utilize.
    --remove-lineage: Flag to execute the remove.lineage command.
    --lineage-exclude: Filename for lineage exclusion.
    --log-file: Path to the log file for mothur processing.

### Example Command
python3 mothur_processing.py \
    --combined-fasta "../combined.fasta" \
    --combined-group "../combined.groups" \
    --output-dir "../output_dir" \
    --reference-fasta "../sbanalyzer/lib/athena_v2_2/athena_v2_2.fna" \
    --taxonomy-file "../sbanalyzer/lib/athena_v2_2/athena_v2_2.tax" \
    --method knn \
    --numwanted 1 \
    --search blastplus \
    --processors 16 \
    --remove-lineage \
    --lineage-exclude lineage.exclude \
    --log-file "../mothur_processing.log"

## Notes
### File Naming Conventions:
The pipeline expects demultiplexed BAM files to follow the pattern:
*.Kinnex16S_Fwd_XX--Kinnex16S_Rev_YY.bam
Files not meeting this format are moved to an invalid_files directory and logged.

### Environment Setup:
Ensure all required modules and external tools (skera, lima, bam2fastq, bam2fasta, samtools, mothur) are installed and properly loaded.

### Error Handling:
Each step in the pipeline includes logging to help troubleshoot issues. Check the log files (pipeline.log for analysis and the specified mothur log file) for detailed information if errors occur.

### Customization:
Modify file paths and parameters as necessary to match your environment and data.
